<!doctype html>

<html class="no-js" lang="fr">
	<head>
		<meta charset="UTF-8">
		<title>test Chessboard</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="/static/css/bootstrap.css" media="all">
		<link rel="stylesheet" href="/static/css/chessboard-0.3.0.min.css" media="all">
		<link rel="stylesheet" href="/static/css/styles.css" media="all">
	</head>
	<body>
		<div class="row-fluid">
			<div id="board"></div>
			<div class="container">
				<div id="currentScore"></div>
				<div class="mytable">
					<table class="table table-striped">
					</table>
				</div>
				<div class="buttons">
					<button type="button" id="begin"><i class="icon-fast-backward"></i></button>
					<button type="button" id="backward"><i class="icon-step-backward"></i></button>
					<button type="button" id="forward"><i class="icon-step-forward"></i></button>
					<button type="button" id="end"><i class="icon-fast-forward"></i></button>
				</div>
			</div>
			<div id="area"></div>
		</div>
		<script type="text/javascript" src="/static/js/jquery.min.js" ></script>
		<script type="text/javascript" src="/static/js/chessboard-0.3.0.min.js" ></script>
		<script type="text/javascript" src="/static/js/json3.min.js" ></script>
		<script type="text/javascript" src="/static/js/bootstrap.min.js" ></script>
		<script type="text/javascript" src="/static/js/highcharts.js"></script>
		<script>
			$(document).ready(function() {
				var pos = -1;
				var board = ChessBoard('board', {
					pieceTheme	: '/static/img/chesspieces/{piece}.png'
					, position	: 'start'
					, draggable	: false
					, showErrors 	: 'console'
				});

				var fens = [<% for(var i in moves) { %> '<%= moves[i].fen %>' ,<% } %>];
				var moveTable = $(".mytable");

				moveTable.find($("table")).append(
					<% for(var i in moves) { %>
						<% if(i%2 == 0) { %>
							<% if (moves[i].depths[19].scoreCp * -1 > 0) { %>
								'<tr><td><%= i/2 %></td><td id="<%= i %>"><%= moves[i].position %><p>+' + <%= moves[i].depths[19].scoreCp %> * -1 + '</p></td>' +
							<% } else if (moves[i].depths[19].scoreCp * -1 <= 0) { %>
								'<tr><td><%= i/2 %></td><td id="<%= i %>"><%= moves[i].position %><p>' + <%= moves[i].depths[19].scoreCp %> * -1 + '</p></td>' +
							<% } %>
						<% } else { %>
							<% if ( moves[i].depths[19].scoreCp > 0) { %>
								'<td id="<%= i %>"><%= moves[i].position %><p>+' + <%= moves[i].depths[19].scoreCp %> + '</p></td></tr>' +
							<% } else if (moves[i].depths[19].scoreCp <= 0) { %>
								'<td id="<%= i %>"><%= moves[i].position %><p>' + <%= moves[i].depths[19].scoreCp %> + '</p></td></tr>' +
							<% } %>
						<% } %>
					<% } %>
				"");

				$('#area').highcharts({
				   	chart: {
				       type: 'area',
					   height: 400,
			           width: 1000,
					},
					title: {
					   text: 'Moves score of players'
					},
					xAxis: {
						categories: [<% for(var i in moves) { %> '<%= moves[i].position %>' ,<% } %>],
						plotBands: [{
							color: '#F0D9B5',
							from: -0.5,
							to: <%= game.opening.length %> - 0.5,
							label: {
							   text: '<%= game.opening.name %><br/><%= game.opening.variation%>'
							}
						}],
					},
					/*tooltip: {
					    formatter: function() {
					        return 'The value for <b>' + this.x + '</b> is <b>' + this.y + '</b>, in series '+ this.series.name;
					    }
					},*/
					yAxis: {
						// min: -200,
						// max: 200,
						title: {
							text: 'Score'
						}
					},
					series: [{
						name: 'Scores',
						data: [<% for(var i in moves) { %> <%= moves[i].depths[19].scoreCp %> ,<% } %>],
						color: '#F4E4CB',
						negativeColor: '#B58863',
						point: {
				            events: {
				                click: function (e) {
									moveChange(e.point.index);
				                }
				            }
				        },
						allowPointSelect: true,
						marker: {
							radius: 1,
							states: {
								select: {
								   radius: 3,
								   fillColor: '#B58863'
								}
							}
						}
				   }]
				});
				var chart = Highcharts.charts[0];

				var moveChange = function(id){
					moveTable.find($("td#" + pos)).css("background-color","");
					pos = id;
					board.position(fens[pos]);
					moveTable.find($("td#" + pos)).css("background-color","#C39F82");
					moveTable.scrollTop($('td#0').offset().top);
					moveTable.scrollTop($('td#' + pos).offset().top - 100);
				}
				var stepBegin = function(){
					if (pos > -1){
						board.start();
						chart.series[0].points[pos].select(false);
						moveTable.find($('td#' + pos)).css("background-color","");
						moveTable.scrollTop(moveTable.find($('td#0')).offset().top - 100);
						pos = -1;
					}
				}
				var stepForward = function(){
					if (pos < fens.length - 1){
						moveChange(pos+1);
						chart.series[0].points[pos].select();
					}
				}
				var stepBackward = function(){
					if (pos > 0){
						moveChange(pos-1);
						chart.series[0].points[pos].select();
					}
					else{
						stepBegin();
					}
				}
				var stepEnd = function(){
					moveChange(fens.length - 1);
					chart.series[0].points[pos].select();
				}

				$(".mytable	td").click(function(){
					moveChange($(this).attr('id'));
					chart.series[0].points[pos].select();
				});

				$('.buttons button').on('click', function(){
					if ($(this).attr("id") == "forward"){
						stepForward();
					}
					if ($(this).attr("id") == "backward"){
						stepBackward();
					}
					if ($(this).attr("id") == "begin"){
						stepBegin();
					}
					if ($(this).attr("id") == "end"){
						stepEnd();
					}
				});

				moveTable.find($("td:last-child, td:nth-last-child(2)")).hover(function(){
					$(this).css('cursor', 'pointer');
					if ($(this).css('background-color') == "rgb(249, 249, 249)" || $(this).css('background-color') == "transparent"){
						$(this).css('background-color', '#F0D9B5');
					}
				}, function() {
					$(this).css('cursor','auto');
					if ($(this).css('background-color') != "rgb(195, 159, 130)"){
						$(this).css('background-color', '');
					}
				});
			});
		</script>
	</body>
</html>
